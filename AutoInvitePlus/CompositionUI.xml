<Ui xmlns="http://www.blizzard.com/wow/ui" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!-- Raid Composition Advisor Frame -->
  <Frame name="AIPCompositionFrame" hidden="true" movable="true" enableMouse="true" parent="UIParent" frameStrata="DIALOG">
    <Size>
      <AbsDimension x="450" y="500"/>
    </Size>
    <Anchors>
      <Anchor point="CENTER"/>
    </Anchors>
    <Backdrop bgFile="Interface\DialogFrame\UI-DialogBox-Background" edgeFile="Interface\DialogFrame\UI-DialogBox-Border" tile="true">
      <BackgroundInsets>
        <AbsInset left="11" right="12" top="12" bottom="11"/>
      </BackgroundInsets>
      <TileSize>
        <AbsValue val="32"/>
      </TileSize>
      <EdgeSize>
        <AbsValue val="32"/>
      </EdgeSize>
    </Backdrop>

    <Layers>
      <Layer level="ARTWORK">
        <Texture name="$parentTitleBorder" file="Interface\DialogFrame\UI-DialogBox-Header">
          <Size>
            <AbsDimension x="220" y="64"/>
          </Size>
          <Anchors>
            <Anchor point="TOP">
              <Offset>
                <AbsDimension x="0" y="12"/>
              </Offset>
            </Anchor>
          </Anchors>
          <TexCoords left="0.2" right="0.8" top="0" bottom="0.6"/>
        </Texture>
        <FontString name="$parentTitle" inherits="GameFontNormal" text="Raid Composition Advisor">
          <Anchors>
            <Anchor point="TOP">
              <Offset>
                <AbsDimension x="0" y="-2"/>
              </Offset>
            </Anchor>
          </Anchors>
        </FontString>
      </Layer>
    </Layers>

    <Frames>
      <!-- Close Button -->
      <Button name="$parentCloseButton" inherits="UIPanelCloseButton">
        <Anchors>
          <Anchor point="TOPRIGHT">
            <Offset>
              <AbsDimension x="-5" y="-5"/>
            </Offset>
          </Anchor>
        </Anchors>
      </Button>

      <!-- Template Dropdown -->
      <Frame name="AIPCompTemplateLabel">
        <Size><AbsDimension x="80" y="20"/></Size>
        <Anchors><Anchor point="TOPLEFT"><Offset><AbsDimension x="20" y="-40"/></Offset></Anchor></Anchors>
        <Layers><Layer level="OVERLAY">
          <FontString inherits="GameFontNormal" text="Template:">
            <Anchors><Anchor point="LEFT"/></Anchors>
          </FontString>
        </Layer></Layers>
      </Frame>

      <Frame name="AIPCompTemplateDropdown" inherits="UIDropDownMenuTemplate">
        <Anchors>
          <Anchor point="LEFT" relativeTo="AIPCompTemplateLabel" relativePoint="RIGHT">
            <Offset><AbsDimension x="-10" y="-3"/></Offset>
          </Anchor>
        </Anchors>
      </Frame>

      <!-- Scan Button -->
      <Button name="AIPCompScanBtn" inherits="UIPanelButtonTemplate" text="Scan Raid">
        <Size><AbsDimension x="80" y="22"/></Size>
        <Anchors>
          <Anchor point="LEFT" relativeTo="AIPCompTemplateDropdown" relativePoint="RIGHT">
            <Offset><AbsDimension x="10" y="3"/></Offset>
          </Anchor>
        </Anchors>
        <Scripts>
          <OnClick>
            if AutoInvitePlus.Composition then
              AutoInvitePlus.Composition.ScanRaid()
              AutoInvitePlus.UpdateCompositionUI()
            end
          </OnClick>
        </Scripts>
      </Button>

      <!-- Role Summary Section -->
      <Frame name="AIPCompRoleSection">
        <Size><AbsDimension x="400" y="80"/></Size>
        <Anchors><Anchor point="TOPLEFT"><Offset><AbsDimension x="20" y="-75"/></Offset></Anchor></Anchors>
        <Layers>
          <Layer level="OVERLAY">
            <FontString name="AIPCompRoleHeader" inherits="GameFontNormal" text="Role Distribution">
              <Anchors><Anchor point="TOPLEFT"/></Anchors>
              <Color r="1" g="0.82" b="0"/>
            </FontString>
          </Layer>
        </Layers>
      </Frame>

      <!-- Tank bar -->
      <Frame name="AIPCompTankBar">
        <Size><AbsDimension x="350" y="18"/></Size>
        <Anchors><Anchor point="TOPLEFT"><Offset><AbsDimension x="25" y="-95"/></Offset></Anchor></Anchors>
        <Layers>
          <Layer level="BACKGROUND">
            <Texture name="AIPCompTankBarBg">
              <Anchors><Anchor point="LEFT"/></Anchors>
              <Size><AbsDimension x="200" y="14"/></Size>
              <Color r="0.2" g="0.2" b="0.2"/>
            </Texture>
          </Layer>
          <Layer level="ARTWORK">
            <Texture name="AIPCompTankBarFill">
              <Anchors><Anchor point="LEFT"/></Anchors>
              <Size><AbsDimension x="100" y="14"/></Size>
              <Color r="0" g="0.5" b="1"/>
            </Texture>
          </Layer>
          <Layer level="OVERLAY">
            <FontString name="AIPCompTankLabel" inherits="GameFontNormalSmall" text="Tanks: 0/2">
              <Anchors><Anchor point="LEFT"><Offset><AbsDimension x="210" y="0"/></Offset></Anchor></Anchors>
            </FontString>
          </Layer>
        </Layers>
      </Frame>

      <!-- Healer bar -->
      <Frame name="AIPCompHealerBar">
        <Size><AbsDimension x="350" y="18"/></Size>
        <Anchors><Anchor point="TOPLEFT"><Offset><AbsDimension x="25" y="-115"/></Offset></Anchor></Anchors>
        <Layers>
          <Layer level="BACKGROUND">
            <Texture name="AIPCompHealerBarBg">
              <Anchors><Anchor point="LEFT"/></Anchors>
              <Size><AbsDimension x="200" y="14"/></Size>
              <Color r="0.2" g="0.2" b="0.2"/>
            </Texture>
          </Layer>
          <Layer level="ARTWORK">
            <Texture name="AIPCompHealerBarFill">
              <Anchors><Anchor point="LEFT"/></Anchors>
              <Size><AbsDimension x="100" y="14"/></Size>
              <Color r="0" g="0.8" b="0"/>
            </Texture>
          </Layer>
          <Layer level="OVERLAY">
            <FontString name="AIPCompHealerLabel" inherits="GameFontNormalSmall" text="Healers: 0/2">
              <Anchors><Anchor point="LEFT"><Offset><AbsDimension x="210" y="0"/></Offset></Anchor></Anchors>
            </FontString>
          </Layer>
        </Layers>
      </Frame>

      <!-- DPS bar -->
      <Frame name="AIPCompDPSBar">
        <Size><AbsDimension x="350" y="18"/></Size>
        <Anchors><Anchor point="TOPLEFT"><Offset><AbsDimension x="25" y="-135"/></Offset></Anchor></Anchors>
        <Layers>
          <Layer level="BACKGROUND">
            <Texture name="AIPCompDPSBarBg">
              <Anchors><Anchor point="LEFT"/></Anchors>
              <Size><AbsDimension x="200" y="14"/></Size>
              <Color r="0.2" g="0.2" b="0.2"/>
            </Texture>
          </Layer>
          <Layer level="ARTWORK">
            <Texture name="AIPCompDPSBarFill">
              <Anchors><Anchor point="LEFT"/></Anchors>
              <Size><AbsDimension x="100" y="14"/></Size>
              <Color r="0.8" g="0" b="0"/>
            </Texture>
          </Layer>
          <Layer level="OVERLAY">
            <FontString name="AIPCompDPSLabel" inherits="GameFontNormalSmall" text="DPS: 0/6">
              <Anchors><Anchor point="LEFT"><Offset><AbsDimension x="210" y="0"/></Offset></Anchor></Anchors>
            </FontString>
          </Layer>
        </Layers>
      </Frame>

      <!-- Class Distribution Section -->
      <Frame name="AIPCompClassSection">
        <Size><AbsDimension x="400" y="20"/></Size>
        <Anchors><Anchor point="TOPLEFT"><Offset><AbsDimension x="20" y="-165"/></Offset></Anchor></Anchors>
        <Layers>
          <Layer level="OVERLAY">
            <FontString name="AIPCompClassHeader" inherits="GameFontNormal" text="Class Distribution">
              <Anchors><Anchor point="TOPLEFT"/></Anchors>
              <Color r="1" g="0.82" b="0"/>
            </FontString>
          </Layer>
        </Layers>
      </Frame>

      <!-- Class count display (will be populated by Lua) -->
      <Frame name="AIPCompClassDisplay">
        <Size><AbsDimension x="400" y="60"/></Size>
        <Anchors><Anchor point="TOPLEFT"><Offset><AbsDimension x="25" y="-185"/></Offset></Anchor></Anchors>
        <Layers>
          <Layer level="OVERLAY">
            <FontString name="AIPCompClassText" inherits="GameFontNormalSmall" justifyH="LEFT">
              <Anchors><Anchor point="TOPLEFT"/></Anchors>
              <Size><AbsDimension x="400" y="60"/></Size>
            </FontString>
          </Layer>
        </Layers>
      </Frame>

      <!-- Buff Coverage Section -->
      <Frame name="AIPCompBuffSection">
        <Size><AbsDimension x="400" y="20"/></Size>
        <Anchors><Anchor point="TOPLEFT"><Offset><AbsDimension x="20" y="-255"/></Offset></Anchor></Anchors>
        <Layers>
          <Layer level="OVERLAY">
            <FontString name="AIPCompBuffHeader" inherits="GameFontNormal" text="Buff Coverage">
              <Anchors><Anchor point="TOPLEFT"/></Anchors>
              <Color r="1" g="0.82" b="0"/>
            </FontString>
          </Layer>
        </Layers>
      </Frame>

      <Frame name="AIPCompBuffDisplay">
        <Size><AbsDimension x="400" y="80"/></Size>
        <Anchors><Anchor point="TOPLEFT"><Offset><AbsDimension x="25" y="-275"/></Offset></Anchor></Anchors>
        <Layers>
          <Layer level="OVERLAY">
            <FontString name="AIPCompBuffText" inherits="GameFontNormalSmall" justifyH="LEFT">
              <Anchors><Anchor point="TOPLEFT"/></Anchors>
              <Size><AbsDimension x="400" y="80"/></Size>
            </FontString>
          </Layer>
        </Layers>
      </Frame>

      <!-- Missing Buffs Warning -->
      <Frame name="AIPCompMissingSection">
        <Size><AbsDimension x="400" y="20"/></Size>
        <Anchors><Anchor point="TOPLEFT"><Offset><AbsDimension x="20" y="-365"/></Offset></Anchor></Anchors>
        <Layers>
          <Layer level="OVERLAY">
            <FontString name="AIPCompMissingHeader" inherits="GameFontNormal" text="Missing Buffs">
              <Anchors><Anchor point="TOPLEFT"/></Anchors>
              <Color r="1" g="0.3" b="0.3"/>
            </FontString>
          </Layer>
        </Layers>
      </Frame>

      <Frame name="AIPCompMissingDisplay">
        <Size><AbsDimension x="400" y="40"/></Size>
        <Anchors><Anchor point="TOPLEFT"><Offset><AbsDimension x="25" y="-385"/></Offset></Anchor></Anchors>
        <Layers>
          <Layer level="OVERLAY">
            <FontString name="AIPCompMissingText" inherits="GameFontNormalSmall" justifyH="LEFT">
              <Anchors><Anchor point="TOPLEFT"/></Anchors>
              <Size><AbsDimension x="400" y="40"/></Size>
              <Color r="1" g="0.5" b="0.5"/>
            </FontString>
          </Layer>
        </Layers>
      </Frame>

      <!-- Bottom buttons -->
      <Button name="AIPCompLFMBtn" inherits="UIPanelButtonTemplate" text="Open LFM Browser">
        <Size><AbsDimension x="120" y="25"/></Size>
        <Anchors><Anchor point="BOTTOMLEFT"><Offset><AbsDimension x="20" y="15"/></Offset></Anchor></Anchors>
        <Scripts>
          <OnClick>AutoInvitePlus.ToggleLFMBrowserUI()</OnClick>
        </Scripts>
      </Button>

      <Button name="AIPCompRosterBtn" inherits="UIPanelButtonTemplate" text="Roster Manager">
        <Size><AbsDimension x="110" y="25"/></Size>
        <Anchors><Anchor point="LEFT" relativeTo="AIPCompLFMBtn" relativePoint="RIGHT"><Offset><AbsDimension x="10" y="0"/></Offset></Anchor></Anchors>
        <Scripts>
          <OnClick>AutoInvitePlus.ToggleRosterUI()</OnClick>
        </Scripts>
      </Button>

      <Button name="AIPCompInviteBtn" inherits="UIPanelButtonTemplate" text="Open Queue">
        <Size><AbsDimension x="90" y="25"/></Size>
        <Anchors><Anchor point="LEFT" relativeTo="AIPCompRosterBtn" relativePoint="RIGHT"><Offset><AbsDimension x="10" y="0"/></Offset></Anchor></Anchors>
        <Scripts>
          <OnClick>AutoInvitePlus.ToggleQueueUI()</OnClick>
        </Scripts>
      </Button>

    </Frames>

    <Scripts>
      <OnLoad>
        tinsert(UISpecialFrames, self:GetName())
        -- Initialize template dropdown
        UIDropDownMenu_SetWidth(AIPCompTemplateDropdown, 140)
      </OnLoad>
      <OnShow>
        AutoInvitePlus.InitCompositionUI()
        AutoInvitePlus.UpdateCompositionUI()
      </OnShow>
      <OnDragStart>
        self:StartMoving()
      </OnDragStart>
      <OnDragStop>
        self:StopMovingOrSizing()
      </OnDragStop>
    </Scripts>
  </Frame>

  <!-- Lua code for Composition UI -->
  <Script>
    function AutoInvitePlus.InitCompositionUI()
      -- Initialize template dropdown
      local function TemplateDropdown_Initialize()
        local info = UIDropDownMenu_CreateInfo()

        info.text = "No Template"
        info.value = nil
        info.func = function()
          if AutoInvitePlus.Composition then
            AutoInvitePlus.Composition.CurrentRaid.template = nil
          end
          UIDropDownMenu_SetText(AIPCompTemplateDropdown, "No Template")
          AutoInvitePlus.UpdateCompositionUI()
        end
        UIDropDownMenu_AddButton(info)

        if AutoInvitePlus.Composition and AutoInvitePlus.Composition.RaidTemplates then
          for key, data in pairs(AutoInvitePlus.Composition.RaidTemplates) do
            info = UIDropDownMenu_CreateInfo()
            info.text = data.name
            info.value = key
            info.func = function()
              AutoInvitePlus.Composition.SetTemplate(key)
              UIDropDownMenu_SetText(AIPCompTemplateDropdown, data.name)
              AutoInvitePlus.UpdateCompositionUI()
            end
            UIDropDownMenu_AddButton(info)
          end
        end
      end

      UIDropDownMenu_Initialize(AIPCompTemplateDropdown, TemplateDropdown_Initialize)

      local currentTemplate = AutoInvitePlus.Composition and AutoInvitePlus.Composition.CurrentRaid.template
      if currentTemplate and AutoInvitePlus.Composition.RaidTemplates[currentTemplate] then
        UIDropDownMenu_SetText(AIPCompTemplateDropdown, AutoInvitePlus.Composition.RaidTemplates[currentTemplate].name)
      else
        UIDropDownMenu_SetText(AIPCompTemplateDropdown, "No Template")
      end
    end

    function AutoInvitePlus.UpdateCompositionUI()
      if not AIPCompositionFrame:IsVisible() then return end
      if not AutoInvitePlus.Composition then return end

      local Comp = AutoInvitePlus.Composition
      Comp.ScanRaid()

      local status = Comp.GetCompositionStatus()
      local raid = Comp.CurrentRaid

      -- Update role bars
      local tankCurrent = raid.roleCounts.TANK
      local healerCurrent = raid.roleCounts.HEALER
      local dpsCurrent = raid.roleCounts.DPS

      local tankNeeded = status and status.tanks.needed or 2
      local healerNeeded = status and status.healers.needed or 2
      local dpsNeeded = status and status.dps.needed or 6

      -- Tank bar
      local tankPercent = math.min(tankCurrent / tankNeeded, 1)
      AIPCompTankBarFill:SetWidth(math.max(1, 200 * tankPercent))
      AIPCompTankLabel:SetText(string.format("Tanks: %d/%d", tankCurrent, tankNeeded))
      if tankCurrent >= tankNeeded then
        AIPCompTankBarFill:SetVertexColor(0, 0.8, 0)
      elseif tankCurrent > 0 then
        AIPCompTankBarFill:SetVertexColor(1, 0.8, 0)
      else
        AIPCompTankBarFill:SetVertexColor(0.8, 0, 0)
      end

      -- Healer bar
      local healerPercent = math.min(healerCurrent / healerNeeded, 1)
      AIPCompHealerBarFill:SetWidth(math.max(1, 200 * healerPercent))
      AIPCompHealerLabel:SetText(string.format("Healers: %d/%d", healerCurrent, healerNeeded))
      if healerCurrent >= healerNeeded then
        AIPCompHealerBarFill:SetVertexColor(0, 0.8, 0)
      elseif healerCurrent > 0 then
        AIPCompHealerBarFill:SetVertexColor(1, 0.8, 0)
      else
        AIPCompHealerBarFill:SetVertexColor(0.8, 0, 0)
      end

      -- DPS bar
      local dpsPercent = math.min(dpsCurrent / dpsNeeded, 1)
      AIPCompDPSBarFill:SetWidth(math.max(1, 200 * dpsPercent))
      AIPCompDPSLabel:SetText(string.format("DPS: %d/%d", dpsCurrent, dpsNeeded))
      if dpsCurrent >= dpsNeeded then
        AIPCompDPSBarFill:SetVertexColor(0, 0.8, 0)
      elseif dpsCurrent > 0 then
        AIPCompDPSBarFill:SetVertexColor(1, 0.8, 0)
      else
        AIPCompDPSBarFill:SetVertexColor(0.8, 0, 0)
      end

      -- Class distribution
      local classStr = ""
      for class, count in pairs(raid.classCounts) do
        if count > 0 then
          classStr = classStr .. Comp.ColoredClassName(class) .. ": " .. count .. "  "
        end
      end
      AIPCompClassText:SetText(classStr ~= "" and classStr or "No players in group")

      -- Buff coverage
      local buffStr = ""
      local importantBuffs = {"Bloodlust/Heroism", "Replenishment", "Blessing of Kings", "Power Word: Fortitude"}
      for _, buffName in ipairs(importantBuffs) do
        local available = raid.buffsAvailable[buffName]
        local color = available and "|cFF00FF00" or "|cFFFF0000"
        local status = available and "YES" or "NO"
        buffStr = buffStr .. buffName .. ": " .. color .. status .. "|r\n"
      end
      AIPCompBuffText:SetText(buffStr)

      -- Missing buffs
      local missing = Comp.GetMissingBuffs()
      if #missing > 0 then
        AIPCompMissingText:SetText(table.concat(missing, ", "))
        AIPCompMissingSection:Show()
        AIPCompMissingDisplay:Show()
      else
        AIPCompMissingText:SetText("All required buffs covered!")
        AIPCompMissingText:SetTextColor(0, 1, 0)
      end
    end

    function AutoInvitePlus.ToggleCompositionUI()
      if AIPCompositionFrame:IsVisible() then
        AIPCompositionFrame:Hide()
      else
        AIPCompositionFrame:Show()
      end
    end
  </Script>

</Ui>
